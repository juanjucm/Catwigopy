import tweepy
from catwigopy.auxiliar import preprocess_tweet


def do_authentication(consumer_key, consumer_secret, access_token, access_token_secret):

    """
    This function authenticates in Twitter API service via Tweepy.

    :param consumer_key: consumer key generated by creating Twitter application.
    :param consumer_secret: consumer secret key generated by creating Twitter application.
    :param access_token: access token key generated by creating Twitter application.
    :param access_token_secret: access token secret key generated by creating Twitter application.

    :return: api instance
    """

    # Authentication process:
    auth = tweepy.OAuthHandler(consumer_key, consumer_secret)
    auth.set_access_token(access_token, access_token_secret)

    api = tweepy.API(auth,
                     # check remaining calls and block until replenished
                     wait_on_rate_limit=True,
                     # retry 3 times with 5 seconds delay when getting these error codes
                     retry_count=3,
                     retry_delay=5,
                     retry_errors=set([401, 404, 500, 503]))

    return api


def search_user_tweets(api, user_screen_name, number_of_tweets):

    """
    This function use Tweepy to retrieve user tweets. For each tweet, it calls the preprocessing method to clean it up.
    Also extract user's basic information as profile image, description, etc.

    :param api: Twitter API instance for Tweepy.
    :param user_screen_name: User's Twitter name (@name).
    :param number_of_tweets: Number of tweets to retrieve

    :return: an array containing each tweet as a dict, basic information.
    """
    tweets_array = list()

    tweets = [tweet._json for tweet in tweepy.Cursor(api.user_timeline, id=user_screen_name, tweet_mode='extended').items(number_of_tweets) if not 'retweeted_status' in tweet._json.keys()]

    for tweet in tweets:
        # Get the text and hashtags
        text = tweet['full_text']
        hashtags = ['#' + h['text'] for h in tweet['entities']['hashtags']]

        # preprocess tweet
        result = preprocess_tweet(text)
        # Create the document
        twt = {'text': text,
               'hashtags': hashtags,
               'preprocessed_tweet': result[0],
               'preprocessed_tokens': result[1]
               }

        tweets_array.append(twt)

    return tweets_array, tweets[0]['user']['profile_image_url_https'], tweets[0]['user']['name'], tweets[0]['user']['description']


def get_user_follows(api, user_screen_name, number_of_users):

    """
    This function retrieves the list of accounts followed by the user.

    :param api: Twitter API instance for Tweepy.
    :param user_screen_name: User's Twitter name (@name).
    :param number_of_users: Number of accounts to retrieve.

    :return: list containing the followed accounts.
    """


    followed_users = [user.screen_name for user in tweepy.Cursor(api.friends, screen_name=user_screen_name).items(number_of_users)]
    return followed_users
